---
title: "Report"
output:   
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 4
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(lubridate)
library(ggplot2)
library(lubridate)
library(knitr)
library(rvest)
```

## Motivation

Extreme weather is on the rise due to climate change, with many, especially those who come from a lower socioeconomic background, already feeling the adverse effects changing weather patterns. Asthma is a co-morbidity for other chronic diseases and also disproportionately affects those from a lower economic status. In this project, we want to focus on asthma prevalence as hotter temperatures can lead to more pollen, air pollution, and other lung irritants. Studying these trends will help understand the health risks in vulnerable populations.

## Related Work

Our analysis stems from data provided by the [Behavioral Risk Factor Surveillance System (BRFSS) Prevalence Data](https://www.cdc.gov/asthma/brfss/default.htm). At first we only want to find the association between temperature and asthma prevalence. However, since CDC also provides information about race and income, we want to investigate if they are also associate with asthma prevalence.

## Key Questions:                                                                                                                                
1. How do asthma cases correlate with temperature extremes?                                                     
2. Are there temporal or spatial patterns in asthma prevalence?
3. Are there other factors influence asthma prevalence?

## Data

The analysis uses two primary datasets: Asthma Data and Temperature Data. 

### Temperature Data

To import the temperature data, we used the rnoaa library using R. We first began by defining the scope of the area we were investigating (i.e. all 50 states of the United States) and used ghcnd_stations() to randomly select 30 monitors from each state:

```{r, eval=FALSE}
state_codes = c("AL", "AK", "AZ", "AR", "CA", "CO", "CT", "DE", "FL", "GA", "HI", "ID", "IL", "IN", "IA", "KS", "KY", "LA", "ME", "MD", "MA", "MI", "MN", "MS", "MO", "MT", "NE", "NV", "NH", "NJ", "NM", "NY", "NC", "ND", "OH", "OK", "OR", "PA", "RI", "SC", "SD", "TN", "TX", "UT", "VT", "VA", "WA", "WV", "WI", "WY")

state_stations = ghcnd_stations() %>% 
  filter(state %in% state_codes) %>% 
  select(id, state) %>% 
  group_by(state) %>% 
  sample_n(30) %>% 
  ungroup()
```

We then defined a function that take user import for the monitor ID and state of interest and return the seasonal average from 2011 to 2021. The function uses meteo_pull_monitors() and finds the maximum and minimum temperatures from the inputted monitor ID for everyday from 1/1/2011 to 12/31/2021. If these values are available, then the daily average temperatures returned. These are found by converting to Celsius and averaging the maximum and minimum temperatures. The months are then assigned to a specific season (e.g. months 12, 1, and 2 are assigned to winter). If the max/min values are not available, the function returns NULL:

```{r function rnoaa, eval=FALSE}
temp_func <- function(monitor_id, state) {
 
  avg_temp <- meteo_pull_monitors(
    monitors = monitor_id,
    var = c("TMAX", "TMIN"),
    date_min = "2011-01-01",
    date_max = "2021-12-31"
  )
  
  if ("tmin" %in% colnames(avg_temp) && "tmax" %in% colnames(avg_temp)) {
    
    avg_temp <- avg_temp %>%
      mutate(
        state = state, 
        tmin = tmin / 10,  
        tmax = tmax / 10,  
        tavg_daily = (tmin + tmax) / 2,  
        date = as.character(date)
      ) %>%
      separate(date, into = c("year", "month", "day"), sep = "-") %>%
      mutate(
        across(c(year, month, day), as.numeric),  
        season = case_when(
          month %in% c(12, 1, 2) ~ "Winter",
          month %in% c(3, 4, 5) ~ "Spring",
          month %in% c(6, 7, 8) ~ "Summer",
          month %in% c(9, 10, 11) ~ "Fall"
        )
      ) %>%
      drop_na()  
    
    return(avg_temp)
  } else {
    return(NULL)
  }
}
```

To extract the data, plan() and future_map2() were used. This allows multiple local machines to work in tandem to reduce computation time. This was necessary as we were working with a large dataset. In this case, all available machines except one were used to execute this code. future_map2() was used to pull each station in each state to input into the temp_func() defined and described above to find the daily average. These values are then binded into one dataframe and grouped by state, year, and season to find the seasonal avarage temperature for each state in each year:

```{r, eval=FALSE}
plan(multisession, workers = parallel::detectCores() - 1)

temp_data_list = 
  future_map2(state_stations$id, 
              state_stations$state, 
              temp_func, 
              .options = furrr_options(seed = TRUE))
```

Finally, the data was saved in a .csv to be used in our analyses:

```{r, eval=FALSE}
seasonal_avg_temps = bind_rows(temp_data_list) %>% 
  group_by(state, year, season) %>% 
  summarize(avg_temp = mean(tavg_daily, na.rm = TRUE))

write.csv(seasonal_avg_temps, "temp_data.csv", row.names = FALSE)
```

### Asthma Data

As mentioned, the asthma dataset was obtained from the <a href="https://www.cdc.gov/asthma/brfss/default.htm">CDC Behavioral Risk Factor Surveillance System (BRFSS)</a> data. While initially we wanted to use data from 2001 to 2021, there was a change in weighting method in 2011 that made data collected from the previous period incomparable with data collected 2011 on wards. Therefore, for this analysis, we only use data from the 2011 to 2021 (the most recent year available) period. 

For the dataset, our group used the current asthma prevalence (C) tables rather than lifetime prevalence as it captures active asthma cases during the data collection period. The variables kept were **state, race, income, and prevalence percent.** The prevalence percent was used as it better captured the different sample size each state had. Only data from the 50 states was used and data from territories (PR, VI, and GU) were excluded.

During the data scraping and cleaning process, we found several inconsistencies between year such as: 
<ul>
      <li> **Different column names:** for example, starting from 2016, the column for "prevalence number" in C1 data change to "weighted number". For race data, in 2020, race designation is in column raceg while in 2021, the data is put in column race_ethnicitygcolumn.</li>
      <li>**Missing states:**For example, in 2019, the prevalence data did not include NJ while in 2021 it did not include FL.</li>
      <li>**Superscript that is included as part of the data:** For the race data, the total prevalence is listed as "U.S. totalf" in 2020 and 2021, rather than the usual "U.S. total" due to the "f" superscript.</li>
    </ul>

All of these discrepancies were solved during the cleaning process.

**Importing Data:**
since the data are located at different links, we made a function to obtain the prevalence data:

```{r asthma function, warning=FALSE, message=FALSE, eval=FALSE}
asthma_hmtl = function(url) {
  
  df = 
    read_html(url) %>% 
    html_table() %>% 
    bind_rows() %>% 
    janitor::clean_names() %>% 
    select(1:4) %>% 
    mutate(standard_error = as.numeric(standard_error)) %>% 
    filter(!state %in% c("U.S. Total**", "U.S. Totalf", "Territories", "PR", "GU", "VI")) %>% 
    mutate(prevalence_percent = as.numeric(prevalence_percent))
}
```
**Calculating Prevalence:**
Using the function we defined, we calculated the prevalence in each year by state. Below is a graph that shows the distributions of asthma case by year:

```{r asthma prevalence, message=FALSE, warning=FALSE, eval=FALSE}
#prevalence
asthma_prevalence = 
  tibble(
    year_name = 2011:2021,
    data_url = c(
    "https://www.cdc.gov/asthma/brfss/2011/tableC1.htm",
    "https://www.cdc.gov/asthma/brfss/2012/tableC1.htm", 
    "https://www.cdc.gov/asthma/brfss/2013/tableC1.htm",
    "https://www.cdc.gov/asthma/brfss/2014/tableC1.htm",
    "https://www.cdc.gov/asthma/brfss/2015/tableC1.htm",
    "https://www.cdc.gov/asthma/brfss/2016/tableC1.htm",
    "https://www.cdc.gov/asthma/brfss/2017/tableC1.htm",
    "https://www.cdc.gov/asthma/brfss/2018/tableC1.html",
    "https://www.cdc.gov/asthma/brfss/2019/tableC1.html",
    "https://www.cdc.gov/asthma/brfss/2020/tableC1.html",
    "https://www.cdc.gov/asthma/brfss/2021/tableC1.html")
  ) %>% 
  mutate(asthma_byyear = map(data_url, asthma_hmtl)) %>% 
  unnest(asthma_byyear) %>% 
  select(-data_url, -sample_size, -sample_sizec, -standard_error) %>% 
  group_by(year_name)
```

#### Race and Income Data

A new function was developed to scrape asthma cases by race and income as they had additional columns to include in our analysis 
```{r function2, warning=FALSE, message=FALSE, eval=FALSE}
#function 2 for race and income data
asthma_hmtl2 = function(url) {
  
  df = 
    read_html(url) %>% 
    html_table() %>% 
    bind_rows() %>% 
    janitor::clean_names() %>% 
    select(1:4) %>% 
    filter(!state %in% c("U.S. Total**", "U.S. Totalf", "Territories", "PR", "GU", "VI")) %>% 
    mutate(prevalence_percent = as.numeric(prevalence_percent))
}
```

#### Race  
For race data, since 2021 the survey collected race and ethinicity data, the categories are slightly different. We kept the new terms, however we merged "multi" and "multirace" as the same category to help simplify the category available.  

```{r race, message=FALSE, warning=FALSE, eval=FALSE}
asthma_prace = 
  tibble(
    year_name = 2011:2021,
    data_url = c(
    "https://www.cdc.gov/asthma/brfss/2011/tableC4.htm",
    "https://www.cdc.gov/asthma/brfss/2012/tableC4.htm", 
    "https://www.cdc.gov/asthma/brfss/2013/tableC4.htm",
    "https://www.cdc.gov/asthma/brfss/2014/tableC4.htm",
    "https://www.cdc.gov/asthma/brfss/2015/tableC4.htm",
    "https://www.cdc.gov/asthma/brfss/2016/tableC4.htm",
    "https://www.cdc.gov/asthma/brfss/2017/tableC4.htm",
    "https://www.cdc.gov/asthma/brfss/2018/tableC4.html",
    "https://www.cdc.gov/asthma/brfss/2019/tableC4.html",
    "https://www.cdc.gov/asthma/brfss/2020/tableC4.html",
    "https://www.cdc.gov/asthma/brfss/2021/tableC4.html")
  ) %>% 
  mutate(asthma_byyear = map(data_url, asthma_hmtl2)) %>% 
  unnest(asthma_byyear)

asthma_prace = asthma_prace %>% 
  select(-data_url, -sample_size, -sample_sizec) %>% 
  mutate(
    race = ifelse(is.na(race), raceg, race), 
    race = ifelse(is.na(race), race_ethnicityg, race), 
    race = case_when(race == "Multi" ~ "Multirace", TRUE ~ race)
    ) %>% 
  select(-raceg, -race_ethnicityg)
```

#### Income Data

For the income data, in 2020 they used "-" instead of "–" and in 2021 they changed the upper limit in the range to <$25,000, $50,000 and $75,000 (instead of $24,999, $49,999 and $74,000). We merged the data by mutating the dash and the categories. 

```{r income, message=FALSE, warning=FALSE, eval=FALSE}
asthma_pincome = 
  tibble(
    year_name = 2011:2021,
    data_url = c(
    "https://www.cdc.gov/asthma/brfss/2011/tableC7.htm",
    "https://www.cdc.gov/asthma/brfss/2012/tableC7.htm", 
    "https://www.cdc.gov/asthma/brfss/2013/tableC7.htm",
    "https://www.cdc.gov/asthma/brfss/2014/tableC7.htm",
    "https://www.cdc.gov/asthma/brfss/2015/tableC7.htm",
    "https://www.cdc.gov/asthma/brfss/2016/tableC7.htm",
    "https://www.cdc.gov/asthma/brfss/2017/tableC7.htm",
    "https://www.cdc.gov/asthma/brfss/2018/tableC7.html",
    "https://www.cdc.gov/asthma/brfss/2019/tableC7.html",
    "https://www.cdc.gov/asthma/brfss/2020/tableC7.html",
    "https://www.cdc.gov/asthma/brfss/2021/tableC6.html")
  ) %>% 
  mutate(asthma_byyear = map(data_url, asthma_hmtl2)) %>% 
  unnest(asthma_byyear) %>% 
  select(-data_url, -sample_size, -sample_sizec) %>% 
  mutate(
    income = case_when(income == "$15-$24,999" ~ "$15–$24,999", TRUE ~ income),
    income = case_when(income == "$15,000–<$25,000" ~ "$15–$24,999", TRUE ~ income),
    income = case_when(income == "$25-$49,999" ~ "$25–$49,999", TRUE ~ income),
    income = case_when(income == "$25,000–<$50,000" ~ "$25–$49,999", TRUE ~ income),
    income = case_when(income == "$50-$74,999" ~ "$50–$74,999", TRUE ~ income), 
    income = case_when(income == "$50,000–<$75,000" ~ "$50–$74,999", TRUE ~ income)
    )
```

People in the lowest income level (<$15,000) has the highest asthma prevalence across all years while people in the highest income level (>=$75,000) has the lowest prevalence. This suggest that asthma is correlated with income, which will be investigated further in our [analysis](regression.html). 

```{r income2, warning=FALSE, message=FALSE, eval=FALSE}
asthma_pincome = asthma_pincome %>% 
  nest(income, prevalence_percent)
```


### Complete Datasets

**Temperature Data**  

See the complete data set below:

```{r}
temp_data = read_csv(file = "./temp_data.csv", show_col_types = FALSE) %>%
  janitor::clean_names() %>% 
  drop_na()

temp_data %>% 
  knitr::kable(digit = 3) |> 
  kableExtra::kable_styling(bootstrap_options = c("striped", "hover"), font_size = 12) |> 
  kableExtra::scroll_box(width = "100%", height = "300px")
```

The Temperature Data contains `r nrow(temp_data)` observations and `r ncol(temp_data)` variables, with key columns including the date of the temperature reading (date), the region (region), and the recorded temperature (temp). This dataset provides critical environmental context for analyzing the relationship between temperature and asthma cases.  

**Asthma Data**  

For the final dataset that we are using in the analysis, we combine the state prevalence, race and income data into 1 dataframe. We put the race and income into a listcol as they are stratified in each state. 

```{r final dataset, message=FALSE, warning=FALSE, eval=FALSE}
#asthma dataset
asthma_dataset = 
  inner_join(asthma_prevalence, asthma_prace, by = c("year_name", "state")) %>% 
  inner_join(asthma_pincome, by = c("year_name", "state")) %>% 
  janitor::clean_names() %>% 
  rename("race" = "data_x", "income" = "data_y")
```

```{r}
# Load datasets
asthma_data <- read_csv("data/asthma_data.csv", show_col_types = FALSE )

asthma_data %>% 
  knitr::kable(digit = 3) |> 
  kableExtra::kable_styling(bootstrap_options = c("striped", "hover"), font_size = 12) |> 
  kableExtra::scroll_box(width = "100%", height = "300px")
```

The Asthma Data consists of `r nrow(asthma_data)` observations and `r ncol(asthma_data)` variables, which include details such as the date of record, the region, and the number of asthma cases reported (cases). A brief look at the first few rows reveals the following column names: `r paste(colnames(asthma_data), collapse = ", ")`, providing an overview of the key information captured.

## Exploratory Data Analysis
```{r}
# Summary of asthma data
asthma_summary <- asthma_data %>%
  summarize(
    avg_prevalence = mean(prevalence_percent, na.rm = TRUE),
    min_prevalence = min(prevalence_percent, na.rm = TRUE),
    max_prevalence = max(prevalence_percent, na.rm = TRUE)
  )

# Create a tidy table for asthma summary using kable
asthma_summary %>%
  knitr::kable(
    col.names = c("Average Prevalence (%)", "Minimum Prevalence (%)", "Maximum Prevalence (%)"),
    caption = "Summary Statistics for Asthma Prevalence"
  )
```
The average prevalence of asthma across the dataset is approximately 9.42%. The minimum prevalence is 6.2%, while the maximum prevalence is 13.2%. This range suggests notable variability in asthma prevalence across regions or time periods.
```{r}
# Summary of temperature data
temp_summary <- temp_data %>%
  summarize(
    avg_temp_overall = mean(avg_temp, na.rm = TRUE),
    min_temp = min(avg_temp, na.rm = TRUE),
    max_temp = max(avg_temp, na.rm = TRUE)
  )

# Create a tidy table for temperature summary
temp_summary %>%
  knitr::kable(
    col.names = c("Average Temperature (°C)", "Minimum Temperature (°C)", "Maximum Temperature (°C)"),
    caption = "Summary Statistics for Temperature Data"
  )
```
The overall average temperature is approximately 11.88°C, with a wide range from -14.0°C (minimum) to 30.26°C (maximum). The large temperature range indicates that the dataset spans multiple regions with diverse climates.
```{r}
# Average temperature by year
yearly_temp_summary <- temp_data %>%
  group_by(year) %>%
  summarize(
    avg_temp = mean(avg_temp, na.rm = TRUE)
  )

# Create a tidy table for yearly temperature summary
yearly_temp_summary %>%
  knitr::kable(
    col.names = c("Year", "Average Temperature (°C)"),
    caption = "Average Temperature by Year"
  )
```

```{r}
ggplot(yearly_temp_summary, aes(x = year, y = avg_temp)) +
  geom_line(color = "blue") +
  labs(
    title = "Average Temperature Over Time",
    x = "Year",
    y = "Average Temperature (°C)"
  )
```


                      
The line plot shows annual average temperatures over the years. There are visible fluctuations, with some years showing higher average temperatures (e.g., 2012) and others lower (e.g., 2014). The average temperature peaked around 2012 and dipped notably around 2013-2014. There is no clear upward or downward trend in the dataset; instead, temperatures appear cyclical or influenced by short-term climate variations.

```{r}
# Average temperature by season
seasonal_temp_summary <- temp_data %>%
  group_by(season) %>%
  summarize(
    avg_temp = mean(avg_temp, na.rm = TRUE)
  )

# Create a tidy table for seasonal temperature summary
seasonal_temp_summary %>%
  knitr::kable(
    col.names = c("Season", "Average Temperature (°C)"),
    caption = "Average Temperature by Season"
  )
```

```{r}
ggplot(seasonal_temp_summary, aes(x = season, y = avg_temp, fill = season)) +
  geom_bar(stat = "identity") +
  labs(
    title = "Average Temperature by Season",
    x = "Season",
    y = "Average Temperature (°C)"
  )
```

              

The bar plot displays the average temperature for each season. Summer is significantly warmer (22.45°C on average), while Winter is coldest (1.18°C on average). Fall and Spring fall in between. The seasonal temperature differences are as expected, with clear distinctions between warmer and colder periods. The significant gap between Winter and Summer highlights the need to examine whether asthma prevalence increases during colder months due to weather-induced triggers.
```{r}
# Temperature by state
state_temp_summary <- temp_data %>%
  group_by(state) %>%
  summarize(
    avg_temp = mean(avg_temp, na.rm = TRUE)
  )

ggplot(state_temp_summary, aes(x = reorder(state, -avg_temp), y = avg_temp)) +
  geom_bar(stat = "identity", fill = "steelblue") +
  coord_flip() +
  labs(
    title = "Average Temperature by State",
    x = "State",
    y = "Average Temperature (°C)"
  )
```

                                            

The horizontal bar plot ranks states by their average temperature. States on the left (e.g., colder climates) have lower average temperatures, while those on the right (e.g., warmer climates) have higher averages. There is substantial geographic variation in average temperatures across states. States like Alaska are likely on the colder end, while southern states such as Florida or Texas may be on the warmer end.

```{r}
# Merge datasets by year and state
merged_data <- inner_join(
  asthma_data,
  temp_data,
  by = c("year_name" = "year", "state" = "state")
)

# Display first few rows of merged data
head(merged_data)
```
The merged dataset includes columns for year_name, state, prevalence_percent, season, and avg_temp. Each row represents data for a specific state, year, and season, showing asthma prevalence percentages and average temperature.

```{r}
# Calculate correlation
correlation <- cor(
  merged_data$prevalence_percent,
  merged_data$avg_temp,
  use = "complete.obs"
)

cat("The correlation between asthma prevalence and temperature is:", correlation)
```
The correlation between asthma prevalence and temperature is -0.1330356. A correlation of -0.13 suggests a weak negative relationship between temperature and asthma prevalence. This implies that as temperatures increase, asthma prevalence slightly decreases, but the relationship is not strong. This weak correlation indicates that other factors may play more significant roles in asthma prevalence.
```{r}
# Scatter plot with regression line
ggplot(merged_data, aes(x = avg_temp, y = prevalence_percent)) +
  geom_point(alpha = 0.6) +
  geom_smooth(method = "lm", se = FALSE, color = "blue") +
  labs(
    title = "Asthma Prevalence vs Temperature",
    x = "Average Temperature (°C)",
    y = "Asthma Prevalence (%)"
  )
```


The scatter plot visualizes the relationship between average temperature (x-axis) and asthma prevalence (y-axis). A regression line is overlaid, showing a slight downward slope, consistent with the weak negative correlation. The data points are widely scattered, confirming that temperature alone does not strongly predict asthma prevalence. The slight downward slope of the regression line reflects the weak negative correlation. 

Clusters of points around specific temperature ranges (e.g., ~10–20°C) suggest that more observations are concentrated in these moderate temperatures. Warmer temperatures might reduce asthma triggers like cold air exposure, leading to slightly lower prevalence. Other seasonal factors (e.g., pollen in Spring or high humidity in Summer) could interact with temperature and affect asthma prevalence.