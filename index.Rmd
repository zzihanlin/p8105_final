---
title: "Untitled"
author: "Adeena Moghni"
date: "2024-11-25"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(rnoaa)
```

##Weather data

```{r tidying rnoaa data}
state_codes = c("AL", "AK", "AZ", "AR", "CA", "CO", "CT", "DE", "FL", "GA", "HI", "ID", "IL", "IN", "IA", "KS", "KY", "LA", "ME", "MD", "MA", "MI", "MN", "MS", "MO", "MT", "NE", "NV", "NH", "NJ", "NM", "NY", "NC", "ND", "OH", "OK", "OR", "PA", "RI", "SC", "SD", "TN", "TX", "UT", "VT", "VA", "WA", "WV", "WI", "WY")

year = 2001:2021

state_stations = ghcnd_stations() %>% 
  filter(state %in% state_codes) %>% 
  select(id, state) %>% 
  group_by(state) %>% 
  sample_n(30) %>% 
  ungroup()
```

```{r function rnoaa}
temp_func <- function(monitor_id, state) {
 
  avg_temp <- meteo_pull_monitors(
    monitors = monitor_id,
    var = c("TMAX", "TMIN"),
    date_min = "2001-01-01",
    date_max = "2021-12-31"
  )
  
  if ("tmin" %in% colnames(avg_temp) && "tmax" %in% colnames(avg_temp)) {
    
    avg_temp <- avg_temp %>%
      mutate(
        state = state, 
        tmin = tmin / 10,  
        tmax = tmax / 10,  
        tavg_daily = (tmin + tmax) / 2,  
        date = as.character(date)
      ) %>%
      separate(date, into = c("year", "month", "day"), sep = "-") %>%
      mutate(
        across(c(year, month, day), as.numeric),  
        season = case_when(
          month %in% c(12, 1, 2) ~ "Winter",
          month %in% c(3, 4, 5) ~ "Spring",
          month %in% c(6, 7, 8) ~ "Summer",
          month %in% c(9, 10, 11) ~ "Fall"
        )
      ) %>%
      drop_na()  
    
    return(avg_temp)
  } else {
    return(NULL)
  }
}
```

```{r}
library(furrr)

plan(multisession, workers = parallel::detectCores() - 1)

temp_data_list = 
  future_map2(state_stations$id, 
              state_stations$state, 
              temp_func, 
              .options = furrr_options(seed = TRUE))
```

```{r}
seasonal_avg_temps = bind_rows(temp_data_list) %>% 
  group_by(state, year, season) %>% 
  summarize(avg_temp = mean(tavg_daily, na.rm = TRUE))
```

## Asthma data
```{r asthma dataset}
library(rvest)
library(httr)

#write the data loading steps
asthma_2011 = read_html("https://www.cdc.gov/asthma/brfss/2011/tableC1.htm") %>% 
  html_table() %>% 
  bind_rows() %>% 
  janitor::clean_names() %>% 
  select(-x) %>% 
  filter(!state %in% c("U.S. Total**", "Territories", "PR")) %>% 
  mutate(year = "2011")

#i use current asthma prevalence (table c1) rather than lifetime prevalence and also hasn't removed any columns yet as i'm unsure are we using numbers or percentage. 

#write the functions for data loading

asthma_hmtl = function(url, year_name) {
  
  df = 
    read_html(url) %>% 
    html_table() %>% 
    bind_rows() %>% 
    janitor::clean_names() %>% 
    select(-x) %>% 
    filter(!state %in% c("U.S. Total**", "Territories", "PR")) %>% 
    mutate(year = year_name)
}

asthma_dataset = 
  bind_rows(
    asthma_hmtl("https://www.cdc.gov/asthma/brfss/2011/tableC1.htm", "2011"),
    asthma_hmtl("https://www.cdc.gov/asthma/brfss/2012/tableC1.htm", "2012")
  )

asthma_hmtl = function(url) {
  
  df = 
    read_html(url) %>% 
    html_table() %>% 
    bind_rows() %>% 
    janitor::clean_names() %>% 
    select(-x) %>% 
    filter(!state %in% c("U.S. Total**", "Territories", "PR"))
}

asthma_dataset = 
  tibble(
    year_name = 2011:2021,
    data_url = c(
    "https://www.cdc.gov/asthma/brfss/2011/tableC1.htm",
    "https://www.cdc.gov/asthma/brfss/2012/tableC1.htm", 
    "https://www.cdc.gov/asthma/brfss/2013/tableC1.htm",
    "https://www.cdc.gov/asthma/brfss/2014/tableC1.htm",
    "https://www.cdc.gov/asthma/brfss/2015/tableC1.htm",
    "https://www.cdc.gov/asthma/brfss/2016/tableC1.htm",
    "https://www.cdc.gov/asthma/brfss/2017/tableC1.htm",
    "https://www.cdc.gov/asthma/brfss/2018/tableC1.html",
    "https://www.cdc.gov/asthma/brfss/2019/tableC1.html",
    "https://www.cdc.gov/asthma/brfss/2020/tableC1.html",
    "https://www.cdc.gov/asthma/brfss/2021/tableC1.html")
  ) %>% 
  mutate(asthma_byyear = map(data_url, asthma_hmtl)) %>% 
  unnest(asthma_byyear) %>% 
  print()

asthma_master = tibble(
  year_name = 2011:2021, 
  data_url = c(
    "https://www.cdc.gov/asthma/brfss/2011/tableC1.htm",
    "https://www.cdc.gov/asthma/brfss/2012/tableC1.htm", 
    "https://www.cdc.gov/asthma/brfss/2013/tableC1.htm",
    "https://www.cdc.gov/asthma/brfss/2014/tableC1.htm",
    "https://www.cdc.gov/asthma/brfss/2015/tableC1.htm",
    "https://www.cdc.gov/asthma/brfss/2016/tableC1.htm",
    "https://www.cdc.gov/asthma/brfss/2017/tableC1.htm",
    "https://www.cdc.gov/asthma/brfss/2018/tableC1.html",
    "https://www.cdc.gov/asthma/brfss/2019/tableC1.html",
    "https://www.cdc.gov/asthma/brfss/2020/tableC1.html",
    "https://www.cdc.gov/asthma/brfss/2021/tableC1.html"
    )
)


```

