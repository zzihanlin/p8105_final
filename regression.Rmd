---
title: "Regression Analysis"
output:
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 4
    toc_float: true
---

```{r setup, include=FALSE}
library(tidyverse)
library(rnoaa)
library(rvest)
library(httr)
```

```{r asthma dataset,include=FALSE }
#write the data loading steps
asthma_2011 = read_html("https://www.cdc.gov/asthma/brfss/2011/tableC1.htm") %>% 
  html_table() %>% 
  bind_rows() %>% 
  janitor::clean_names() %>% 
  select(1:4) %>% 
  filter(!state %in% c("U.S. Total**", "Territories", "PR")) %>% 
  mutate(year = "2011")

#i use current asthma prevalence (table c1) rather than lifetime prevalence and only keep the prevalence percent (instead of numbers) 
#i am excluding PR, VI, and GU

#write the functions for data loading

asthma_hmtl = function(url) {
  
  df = 
    read_html(url) %>% 
    html_table() %>% 
    bind_rows() %>% 
    janitor::clean_names() %>% 
    select(1:4) %>% 
    mutate(standard_error = as.numeric(standard_error)) %>% 
    filter(!state %in% c("U.S. Total**", "U.S. Totalf", "Territories", "PR", "GU", "VI")) %>% 
    mutate(prevalence_percent = as.numeric(prevalence_percent))
}

#prevalence
asthma_prevalence = 
  tibble(
    year_name = 2011:2021,
    data_url = c(
    "https://www.cdc.gov/asthma/brfss/2011/tableC1.htm",
    "https://www.cdc.gov/asthma/brfss/2012/tableC1.htm", 
    "https://www.cdc.gov/asthma/brfss/2013/tableC1.htm",
    "https://www.cdc.gov/asthma/brfss/2014/tableC1.htm",
    "https://www.cdc.gov/asthma/brfss/2015/tableC1.htm",
    "https://www.cdc.gov/asthma/brfss/2016/tableC1.htm",
    "https://www.cdc.gov/asthma/brfss/2017/tableC1.htm",
    "https://www.cdc.gov/asthma/brfss/2018/tableC1.html",
    "https://www.cdc.gov/asthma/brfss/2019/tableC1.html",
    "https://www.cdc.gov/asthma/brfss/2020/tableC1.html",
    "https://www.cdc.gov/asthma/brfss/2021/tableC1.html")
  ) %>% 
  mutate(asthma_byyear = map(data_url, asthma_hmtl)) %>% 
  unnest(asthma_byyear) %>% 
  select(-data_url, -sample_size, -sample_sizec, -standard_error) %>% 
  group_by(year_name)

#starting from 2016, has column called "weighted_number" instead of prevalence number
#2016 and 2021 includes VI (removed)
#2020 and 2021 has U.S. totalf (removed)
#2019 and 2021 only has 49 states (-NJ and -FL)


#function 2 for race and income data
asthma_hmtl2 = function(url) {
  
  df = 
    read_html(url) %>% 
    html_table() %>% 
    bind_rows() %>% 
    janitor::clean_names() %>% 
    select(1:4) %>% 
    filter(!state %in% c("U.S. Total**", "U.S. Totalf", "Territories", "PR", "GU", "VI")) %>% 
    mutate(prevalence_percent = as.numeric(prevalence_percent))
}

#race
asthma_prace = 
  tibble(
    year_name = 2011:2021,
    data_url = c(
    "https://www.cdc.gov/asthma/brfss/2011/tableC4.htm",
    "https://www.cdc.gov/asthma/brfss/2012/tableC4.htm", 
    "https://www.cdc.gov/asthma/brfss/2013/tableC4.htm",
    "https://www.cdc.gov/asthma/brfss/2014/tableC4.htm",
    "https://www.cdc.gov/asthma/brfss/2015/tableC4.htm",
    "https://www.cdc.gov/asthma/brfss/2016/tableC4.htm",
    "https://www.cdc.gov/asthma/brfss/2017/tableC4.htm",
    "https://www.cdc.gov/asthma/brfss/2018/tableC4.html",
    "https://www.cdc.gov/asthma/brfss/2019/tableC4.html",
    "https://www.cdc.gov/asthma/brfss/2020/tableC4.html",
    "https://www.cdc.gov/asthma/brfss/2021/tableC4.html")
  ) %>% 
  mutate(asthma_byyear = map(data_url, asthma_hmtl2)) %>% 
  unnest(asthma_byyear)

#2020, race designation is in column raceg. 2021 in column race_ethnicityg
asthma_prace = asthma_prace %>% 
  select(-data_url, -sample_size, -sample_sizec) %>% 
  mutate(
    race = ifelse(is.na(race), raceg, race), 
    race = ifelse(is.na(race), race_ethnicityg, race)
    ) %>% 
  select(-raceg, -race_ethnicityg) %>%
  nest(race, prevalence_percent)

#income
asthma_pincome = 
  tibble(
    year_name = 2011:2021,
    data_url = c(
    "https://www.cdc.gov/asthma/brfss/2011/tableC7.htm",
    "https://www.cdc.gov/asthma/brfss/2012/tableC7.htm", 
    "https://www.cdc.gov/asthma/brfss/2013/tableC7.htm",
    "https://www.cdc.gov/asthma/brfss/2014/tableC7.htm",
    "https://www.cdc.gov/asthma/brfss/2015/tableC7.htm",
    "https://www.cdc.gov/asthma/brfss/2016/tableC7.htm",
    "https://www.cdc.gov/asthma/brfss/2017/tableC7.htm",
    "https://www.cdc.gov/asthma/brfss/2018/tableC7.html",
    "https://www.cdc.gov/asthma/brfss/2019/tableC7.html",
    "https://www.cdc.gov/asthma/brfss/2020/tableC7.html",
    "https://www.cdc.gov/asthma/brfss/2021/tableC6.html")
  ) %>% 
  mutate(asthma_byyear = map(data_url, asthma_hmtl2)) %>% 
  unnest(asthma_byyear) %>% 
  select(-data_url, -sample_size, -sample_sizec) %>% 
  nest(income, prevalence_percent)

#asthma dataset
asthma_dataset = 
  inner_join(asthma_prevalence, asthma_prace, by = c("year_name", "state")) %>% 
  inner_join(asthma_pincome, by = c("year_name", "state")) %>% 
  janitor::clean_names() %>% 
  rename("race" = "data_x", "income" = "data_y")
```

```{r, include=FALSE}
# 1. merge asthma prevalance and temp data 
# import two dataset
temp_df = read_csv("data/temp_data.csv")
summary(temp_df)

asthma_df = read_csv("data/asthma_data.csv")
summary(asthma_df)

# find the yearly temperature by state
temp_yearly_df = 
  temp_df |> 
  group_by(state, year) |> 
  summarize(avg_yearly = mean(avg_temp)) |> 
  select(state, year_name = year, avg_temp_yearly = avg_yearly)

# merge two dataset
merged_df = 
  left_join(asthma_df, temp_yearly_df, by=c("state", "year_name")) |> 
  drop_na() 
# after merging yearly avg temperature and prevalence, DC has no temp data
```

```{r, include=FALSE}
race_table = function(url, year ){
  
  table= 
    read_html(url)|>
    html_table()|>
    first()|>
    slice(-1:-5)
  
  table|>
    janitor::clean_names()|>
    select(-c(x,x95_percent_ci_number))|> 
    mutate(year= year)
  
}

race_table1 = function(url, year){
  
  table= 
    read_html(url)|>
    html_table()|>
    first()|>
    slice(-1:-5)
  
  table|>
    janitor::clean_names()|> 
    mutate( year= year)
  
}

race_table_a8 = function(url, year){
  
  html= read_html(url)
  
  table=
    html|>
    html_table()|>
    first()|>
    slice(-1:-5)
  
  table|>
    janitor::clean_names()|> 
    select(-c(x))|> 
    mutate( 
      year= year)
  
}
```

```{r, include=FALSE}
race_2011= race_table("https://www.cdc.gov/asthma/brfss/2011/tableL5.htm", 2011)


race_2012= race_table("https://www.cdc.gov/asthma/brfss/2012/tableL5.htm", 2012)
race_2013= race_table("https://www.cdc.gov/asthma/brfss/2013/tableL5.htm", 2013)
race_2014= race_table("https://www.cdc.gov/asthma/brfss/2014/tableL5.htm", 2014)
race_2015= race_table("https://www.cdc.gov/asthma/brfss/2015/tableL5.htm", 2015)
race_2016= race_table("https://www.cdc.gov/asthma/brfss/2016/tableL5.htm", 2016)
race_2017= race_table1("https://www.cdc.gov/asthma/brfss/2017/tableL5.htm", 2017)
race_2018= race_table_a8("https://www.cdc.gov/asthma/brfss/2018/tableL5.html", 2018)
race_2019= race_table_a8("https://www.cdc.gov/asthma/brfss/2019/tableL5.html", 2019)
race_2020= race_table_a8("https://www.cdc.gov/asthma/brfss/2020/tableL5.html", 2020)|> 
  mutate( race_ethnicity= race_ethnicityg)|> 
  select(-race_ethnicityg)
```

```{r, include=FALSE}
race_data= 
  bind_rows(race_2011, race_2012, race_2013, race_2014, race_2015, race_2016, 
                           race_2017, race_2018, race_2019, race_2020)|> 
  select(-c(x,weighted_number,x95_percent_ci_weighted_number, weighted_numbere, x95_percent_c_id_weighted_number, x95_percent_c_id_percent, sample_sizec, sample_size,   prevalence_number , x95_percent_ci_percent, standard_error)) %>% 
 rename(year_name = year)


race_data
```

```{r, include=FALSE}
race_asthma_df =
  left_join(merged_df, race_data, by = c("state", "year_name")) %>% 
  drop_na() %>% 
  select(-prevalence_percent.x) %>% 
  rename(prevalence_percent = prevalence_percent.y) %>% 
  mutate(prevalence_prop = prevalence_percent / 100)
```


We first conducted a linear regression on all data (no stratification), then on data stratified by race, then on data stratificed by race and income to see which was a better fit model


## Initial Regression on all data

### Check distribution assumption

```{r, message = FALSE, warning = FALSE}
temp_df |> 
  ggplot(aes(x = avg_temp)) +
  geom_histogram() +
  labs(
    title = "distribution of average temperature in 2011-2021",
    xlab = "average temperature",
    ylab = "frequency"
  )

asthma_df |> 
  ggplot(aes(x = prevalence_percent)) +
  geom_histogram() +
  labs(
    title = "distribution of prevalence in 2011-2021",
    xlab = "prevalence (percent)",
    ylab = "frequency"
  )


```
As seen, the two variables generally follow normal distribution

## Regression Results


### Linear Regression:
```{r, message = FALSE, warning = FALSE}

model = lm(prevalence_percent ~ avg_temp_yearly, data = merged_df)

summary(model) %>% 
  broom::tidy() %>% 
  knitr::kable()

par(mfrow = c(2,2))
plot(model)
```

### Linear Regression on Log Transformed Data:

```{r, message = FALSE, warning = FALSE}
model_log = 
  merged_df |> 
    mutate(log_precalence = log(prevalence_percent)) |> 
    lm(log_precalence ~ avg_temp_yearly, data = _)

summary(model_log) %>% 
  broom::tidy() %>% 
  knitr::kable()

par(mfrow = c(2,2))
plot(model_log)
```

### Regression of Data Stratified by Race

#### Linear Regression (main effects):
```{r, message = FALSE, warning = FALSE}
lm_by_race = lm(prevalence_percent ~ avg_temp_yearly + race_ethnicity, data = race_asthma_df)

summary(lm_by_race)%>% 
  broom::tidy() %>% 
  knitr::kable()

plot(lm_by_race)

race_asthma_df =
  race_asthma_df %>% 
  mutate(yhat = predict(lm_by_race, newdata = race_asthma_df)) 

ggplot(race_asthma_df, aes(x = avg_temp_yearly, y = prevalence_percent, color = race_ethnicity)) +
  geom_point() +
  geom_line(aes(y = yhat)) +
  facet_wrap(~ race_ethnicity) +
  labs(
    title = "Asthma Prevalence by Race and Temperature",
    x = "Average Yearly Temperature",
    y = "Asthma Prevalence (%)",
    caption = "line shows predicted prevalence % equation and data points show actual asthma prevalence"
  ) +
  theme(legend.position="none")
```

#### Linear Regression (interaction model):
```{r, message = FALSE, warning = FALSE}
interaction_model = lm(prevalence_percent ~ avg_temp_yearly * race_ethnicity, data = race_asthma_df)

summary(interaction_model)%>% 
  broom::tidy() %>% 
  knitr::kable()

plot(interaction_model)
```

#### Logistic Fit:
```{r, message = FALSE, warning = FALSE}
fit_logistic = glm(prevalence_prop ~ avg_temp_yearly + race_ethnicity, 
                   data = race_asthma_df, 
                   family = binomial())

broom::tidy(fit_logistic) %>% 
  knitr::kable()

plot(fit_logistic)
```


### MLR of Race, Income, and Yearly temp
```{r include = FALSE}
# We use asthma_dataset here, first need to unnest the data
unnested_df = 
  asthma_dataset |> 
  select(-prevalence_percent) |> 
  unnest(race) |> 
  rename(prevalence_race = prevalence_percent) |> 
  unnest(income) |> 
  rename(prevalence_income = prevalence_percent) |> 
  mutate(joint_prevalence = prevalence_race * prevalence_income / 100) |> # here we assume race and income are independent 
  select(-prevalence_income, -prevalence_race) 

# full dataset contains race, income, yearly_temp, and joint prevalence
full_df = 
  left_join(unnested_df, merged_df, by = c("year_name", "state")) |> 
  select(-prevalence_percent)

# data cleaning
full_df = 
  full_df |> 
  drop_na(c(joint_prevalence, avg_temp_yearly)) |> 
  filter(joint_prevalence != 0) |> 
  mutate(log_prevalence = log(joint_prevalence)) |> 
  mutate(race = as.factor(race),
         income = as.factor(income))
```
#### Check distribution
```{r, message = FALSE, warning = FALSE}
# distribution of outcome variable
ggplot(full_df, aes(x = log_prevalence)) + 
  geom_histogram() +
labs(
  title = "distribution of log-transformed outcome variable",
  xlab = "Log-prevalence",
  ylab = "Frequency"
)


```
Distribution after log-transform looks normal

#### Regression Results:
```{r, message = FALSE, warning = FALSE}
model = lm(log_prevalence ~ race + income + avg_temp_yearly, data = full_df)
summary(model)%>% 
  broom::tidy() %>% 
  knitr::kable()

par(mfrow = c(2, 2))
plot(model)
```
R-squared: 0.4398 (~44%), meaning the model explains ~44% of the variance in the log-transformed prevalence.
Adjusted R-squared: 0.4388, similar to the R-squared, indicating that the model generalizes well with the predictors.

Race is a significant predictor overall, but not all race categories are significant. Different racial groups show varying relationships with the outcome. Income is a highly significant predictor, with lower income categories having significantly lower log-prevalence. As the yearly average temperature increases by 1 unit, the log-prevalence decreases slightly (negative association)


