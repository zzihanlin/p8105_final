---
title: "Asthma Data"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(rnoaa)
library(rvest)
library(httr)
```

For maps and figures on weather trends, please refer to the [maps page.](https://klopez67.shinyapps.io/final_draft/) 

## Asthma dataset
The asthma dataset was obtained from the <a href="https://www.cdc.gov/asthma/brfss/default.htm">CDC Behavioral Risk Factor Surveillance System (BRFSS)</a> data. While initially we wanted to use data from 2001 to 2021, there was a change in weighting method in 2011 that made data collected from the previous period incomparable with data collected 2011 onwards. Therefore, for this analysis, we only use data from 2011 to 2021 (the most recent year available) period. 

For the dataset, our group use the current asthma prevalence (C) tables rather than lifetime prevalence as it captures active asthma cases during the data collection period. We also only keep relevant variables (state, race, income) and use prevalence percent rather than prevalence numbers as it better capture the different sample size each state had. Finally, we only cover the 50 states and excluding territories (PR, VI, and GU).

During the data scraping and cleaning process, we found several inconsistencies between year such as: 
<ul>
      <li>Different column name, for example, starting from 2016, the column for "prevalence number" in C1 data change to "weighted number". For race data, in 2020, race designation is in column raceg while in 2021, the data is put in column race_ethnicitygcolumn.</li>
      <li>Missing states in several years. In 2019, the prevalence data did not include NJ while in 2021 it did not include FL.</li>
      <li>Superscript that is included as part of the data: For the race data, the total prevalence is listed as "U.S. totalf" in 2020 and 2021, rather than the usual "U.S. total" due to the "f" superscript.</li>
    </ul>

All of these disrepancies are solved during the cleaning process.

<h4>Prevalence data</h4>
We made the function to obtain the prevalence data as they are located at different links.
```{r asthma function, warning=FALSE, message=FALSE}
asthma_hmtl = function(url) {
  
  df = 
    read_html(url) %>% 
    html_table() %>% 
    bind_rows() %>% 
    janitor::clean_names() %>% 
    select(1:4) %>% 
    mutate(standard_error = as.numeric(standard_error)) %>% 
    filter(!state %in% c("U.S. Total**", "U.S. Totalf", "Territories", "PR", "GU", "VI")) %>% 
    mutate(prevalence_percent = as.numeric(prevalence_percent))
}
```

<b>Prevalence data</b>

```{r asthma prevalence, message=FALSE, warning=FALSE}
#prevalence
asthma_prevalence = 
  tibble(
    year_name = 2011:2021,
    data_url = c(
    "https://www.cdc.gov/asthma/brfss/2011/tableC1.htm",
    "https://www.cdc.gov/asthma/brfss/2012/tableC1.htm", 
    "https://www.cdc.gov/asthma/brfss/2013/tableC1.htm",
    "https://www.cdc.gov/asthma/brfss/2014/tableC1.htm",
    "https://www.cdc.gov/asthma/brfss/2015/tableC1.htm",
    "https://www.cdc.gov/asthma/brfss/2016/tableC1.htm",
    "https://www.cdc.gov/asthma/brfss/2017/tableC1.htm",
    "https://www.cdc.gov/asthma/brfss/2018/tableC1.html",
    "https://www.cdc.gov/asthma/brfss/2019/tableC1.html",
    "https://www.cdc.gov/asthma/brfss/2020/tableC1.html",
    "https://www.cdc.gov/asthma/brfss/2021/tableC1.html")
  ) %>% 
  mutate(asthma_byyear = map(data_url, asthma_hmtl)) %>% 
  unnest(asthma_byyear) %>% 
  select(-data_url, -sample_size, -sample_sizec, -standard_error) %>% 
  group_by(year_name)

asthma_prevalence %>% 
  mutate(year_name = as.factor(year_name)) %>% 
  ggplot(aes(x = year_name, y = prevalence_percent)) + 
  geom_boxplot(aes(fill = year_name), color = "blue", alpha = .5) + 
  labs(
    x = "Year",
    y = "Prevalence_percent",
    title = "Asthma cases by year"
  ) +
  theme_minimal()

asthma_prevalence %>% 
  ggplot(aes(x = state, y = prevalence_percent)) + 
  geom_boxplot() + 
  labs(
    x = "State",
    y = "Prevalence_percent",
    title = "Asthma cases by state"
  ) +
  theme_minimal()
```

Looking at the annual trend, we see that asthma prevalence show a slightly increasing trend since 2014. Looking at the states data, the highest prevalence are found in RI, ME, KY, WV and VT while the lowest prevalence are found in TX, FL, NE, LA, SD. 

<h4> Race and income data</h4>

New function was developed to scrape race and income data as they had additional columns. 
```{r function2, warning=FALSE, message=FALSE}
#function 2 for race and income data
asthma_hmtl2 = function(url) {
  
  df = 
    read_html(url) %>% 
    html_table() %>% 
    bind_rows() %>% 
    janitor::clean_names() %>% 
    select(1:4) %>% 
    filter(!state %in% c("U.S. Total**", "U.S. Totalf", "Territories", "PR", "GU", "VI")) %>% 
    mutate(prevalence_percent = as.numeric(prevalence_percent))
}
```

<b>Race</b>
For race data, since 2021 the survey collected race and ethinicity data, so the categories are slightly different. We keep the new terms, however we merged "multi" and "multirace" as the same category to help simplify the category available.  

```{r race, message=FALSE, warning=FALSE}
asthma_prace = 
  tibble(
    year_name = 2011:2021,
    data_url = c(
    "https://www.cdc.gov/asthma/brfss/2011/tableC4.htm",
    "https://www.cdc.gov/asthma/brfss/2012/tableC4.htm", 
    "https://www.cdc.gov/asthma/brfss/2013/tableC4.htm",
    "https://www.cdc.gov/asthma/brfss/2014/tableC4.htm",
    "https://www.cdc.gov/asthma/brfss/2015/tableC4.htm",
    "https://www.cdc.gov/asthma/brfss/2016/tableC4.htm",
    "https://www.cdc.gov/asthma/brfss/2017/tableC4.htm",
    "https://www.cdc.gov/asthma/brfss/2018/tableC4.html",
    "https://www.cdc.gov/asthma/brfss/2019/tableC4.html",
    "https://www.cdc.gov/asthma/brfss/2020/tableC4.html",
    "https://www.cdc.gov/asthma/brfss/2021/tableC4.html")
  ) %>% 
  mutate(asthma_byyear = map(data_url, asthma_hmtl2)) %>% 
  unnest(asthma_byyear)

asthma_prace = asthma_prace %>% 
  select(-data_url, -sample_size, -sample_sizec) %>% 
  mutate(
    race = ifelse(is.na(race), raceg, race), 
    race = ifelse(is.na(race), race_ethnicityg, race), 
    race = case_when(race == "Multi" ~ "Multirace", TRUE ~ race)
    ) %>% 
  select(-raceg, -race_ethnicityg)

asthma_prace %>% 
  ggplot(aes(x = year_name, y = prevalence_percent, color = race)) + 
  geom_boxplot() + 
  facet_wrap(~ race) +
  labs(
    x = "Year",
    y = "Prevalence_percent",
    title = "Asthma prevalence by year by race & ethnicity"
  ) +
  theme_minimal()


```

People identified as Black and Multirace have higher asthma prevalence distribution compared to the other groups, while While and White NH have the lowest. This suggest that asthma may be correlated with race, which will be investigated further in the analysis.

```{r race2, warning=FALSE, message=FALSE}
asthma_prace = asthma_prace %>%
  nest(race, prevalence_percent)
```

<b>Income data</b>
For the income data, in 2020 they used "-" instead of "–" and in 2021 they changed the upper limit in the range to <$25,000, $50,000 and $75,000 (instead of $24,999, $49,999 and $74,000). We merged the data by mutating the dash and the categories. 

```{r income, message=FALSE, warning=FALSE}
asthma_pincome = 
  tibble(
    year_name = 2011:2021,
    data_url = c(
    "https://www.cdc.gov/asthma/brfss/2011/tableC7.htm",
    "https://www.cdc.gov/asthma/brfss/2012/tableC7.htm", 
    "https://www.cdc.gov/asthma/brfss/2013/tableC7.htm",
    "https://www.cdc.gov/asthma/brfss/2014/tableC7.htm",
    "https://www.cdc.gov/asthma/brfss/2015/tableC7.htm",
    "https://www.cdc.gov/asthma/brfss/2016/tableC7.htm",
    "https://www.cdc.gov/asthma/brfss/2017/tableC7.htm",
    "https://www.cdc.gov/asthma/brfss/2018/tableC7.html",
    "https://www.cdc.gov/asthma/brfss/2019/tableC7.html",
    "https://www.cdc.gov/asthma/brfss/2020/tableC7.html",
    "https://www.cdc.gov/asthma/brfss/2021/tableC6.html")
  ) %>% 
  mutate(asthma_byyear = map(data_url, asthma_hmtl2)) %>% 
  unnest(asthma_byyear) %>% 
  select(-data_url, -sample_size, -sample_sizec) %>% 
  mutate(
    income = case_when(income == "$15-$24,999" ~ "$15–$24,999", TRUE ~ income),
    income = case_when(income == "$15,000–<$25,000" ~ "$15–$24,999", TRUE ~ income),
    income = case_when(income == "$25-$49,999" ~ "$25–$49,999", TRUE ~ income),
    income = case_when(income == "$25,000–<$50,000" ~ "$25–$49,999", TRUE ~ income),
    income = case_when(income == "$50-$74,999" ~ "$50–$74,999", TRUE ~ income), 
    income = case_when(income == "$50,000–<$75,000" ~ "$50–$74,999", TRUE ~ income)
    )

asthma_pincome %>% 
  ggplot(aes(x = year_name, y = prevalence_percent, color = income)) + 
  geom_point(alpha = 0.5) +
  labs(
    x = "Year",
    y = "Prevalence_percent",
    title = "Asthma prevalence by year by income"
  ) +
  theme_minimal()
```

People in the lowest income level (<$15,000) has the highest asthma prevalence across all years while people in the highest income level (>=$75,000) has the lowest prevalence. This suggest that asthma is correlated with income, which will be investigated further in the analysis. 

```{r income2, warning=FALSE, message=FALSE}
asthma_pincome = asthma_pincome %>% 
  nest(income, prevalence_percent)
```


<h4>Complete dataset</h4>

For the final dataset that we are using in the analysis, we combine the state prevalence, race and income data into 1 dataframe. We put the race and income into a listcol as they are stratified in each state. 

```{r final dataset, message=FALSE, warning=FALSE}
#asthma dataset
asthma_dataset = 
  inner_join(asthma_prevalence, asthma_prace, by = c("year_name", "state")) %>% 
  inner_join(asthma_pincome, by = c("year_name", "state")) %>% 
  janitor::clean_names() %>% 
  rename("race" = "data_x", "income" = "data_y")
```

## fit linear regression
```{r}
# 1. merge asthma prevalance and temp data 
# import two dataset
temp_df = read_csv("data/temp_data.csv")
summary(temp_df)

asthma_df = read_csv("data/asthma_data.csv")
summary(asthma_df)

# find the yearly temperature by state
temp_yearly_df = 
  temp_df |> 
  group_by(state, year) |> 
  summarize(avg_yearly = mean(avg_temp)) |> 
  select(state, year_name = year, avg_temp_yearly = avg_yearly)

# merge two dataset
merged_df = 
  left_join(asthma_df, temp_yearly_df, by=c("state", "year_name")) |> 
  drop_na() 
# after merging yearly avg temperature and prevalence, DC has no temp data
```

```{r}
# 2. do EDA and check distribution assumption
temp_df |> 
  ggplot(aes(x = avg_temp)) +
  geom_histogram() +
  labs(
    title = "distribution of average temperature in 2011-2021",
    xlab = "average temperature",
    ylab = "frequency"
  )

asthma_df |> 
  ggplot(aes(x = prevalence_percent)) +
  geom_histogram() +
  labs(
    title = "distribution of prevalence in 2011-2021",
    xlab = "prevalence (percent)",
    ylab = "frequency"
  )

# two variables generally follows normal distribution
```

```{r}
# bar plot of temperature and line plot of prevalence by each state
merged_df |> 
  mutate(state = reorder(state, avg_temp_yearly)) |> 
  group_by(state) |> 
  summarize(prevalence = mean(prevalence_percent),
            temp = mean(avg_temp_yearly)) |> 
  ggplot(aes(x = state)) +
    geom_bar(aes(y = temp), stat = "identity", fill = "skyblue") +
    geom_line(aes(y = prevalence, group = 1)) +
    geom_point(aes(y = prevalence), color = "red") +
    scale_y_continuous(
      name = "temperature",
      sec.axis = sec_axis(~., name = "Prevalence (%)")
    ) +
  labs(
    title = "Temperature and Prevalence by State",
    color = "legend"
  )

```

```{r}
# 3. do linear regression
model = lm(prevalence_percent ~ avg_temp_yearly, data = merged_df)
summary(model)

par(mfrow = c(2,2))
plot(model)

# try log transform outcome
model_log = 
  merged_df |> 
    mutate(log_precalence = log(prevalence_percent)) |> 
    lm(log_precalence ~ avg_temp_yearly, data = _)
summary(model_log)

par(mfrow = c(2,2))
plot(model_log)
# 4. results explanation and visualization
```




## Race Data & Asthma Prevalance 

Function to download and tidy html table from online 
```{r}
race_table = function(url, year ){
  
  table= 
    read_html(url)|>
    html_table()|>
    first()|>
    slice(-1:-5)
  
  table|>
    janitor::clean_names()|>
    select(-c(x,x95_percent_ci_number))|> 
    mutate(year= year)
  
}

race_table1 = function(url, year){
  
  table= 
    read_html(url)|>
    html_table()|>
    first()|>
    slice(-1:-5)
  
  table|>
    janitor::clean_names()|> 
    mutate( year= year)
  
}

race_table_a8 = function(url, year){
  
  html= read_html(url)
  
  table=
    html|>
    html_table()|>
    first()|>
    slice(-1:-5)
  
  table|>
    janitor::clean_names()|> 
    select(-c(x))|> 
    mutate( 
      year= year)
  
}
```

Run function on all years: 
```{r}
race_2011= race_table("https://www.cdc.gov/asthma/brfss/2011/tableL5.htm", 2011)


race_2012= race_table("https://www.cdc.gov/asthma/brfss/2012/tableL5.htm", 2012)
race_2013= race_table("https://www.cdc.gov/asthma/brfss/2013/tableL5.htm", 2013)
race_2014= race_table("https://www.cdc.gov/asthma/brfss/2014/tableL5.htm", 2014)
race_2015= race_table("https://www.cdc.gov/asthma/brfss/2015/tableL5.htm", 2015)
race_2016= race_table("https://www.cdc.gov/asthma/brfss/2016/tableL5.htm", 2016)
race_2017= race_table1("https://www.cdc.gov/asthma/brfss/2017/tableL5.htm", 2017)
race_2018= race_table_a8("https://www.cdc.gov/asthma/brfss/2018/tableL5.html", 2018)
race_2019= race_table_a8("https://www.cdc.gov/asthma/brfss/2019/tableL5.html", 2019)
race_2020= race_table_a8("https://www.cdc.gov/asthma/brfss/2020/tableL5.html", 2020)|> 
  mutate( race_ethnicity= race_ethnicityg)|> 
  select(-race_ethnicityg)
```

I excluded 2021 since the brackets for race ethnicity were changed and no longer consistent with the previous years where there was a multirace NH category which was no longer used. 

Merged Race data: 
```{r}
race_data= 
  bind_rows(race_2011, race_2012, race_2013, race_2014, race_2015, race_2016, 
                           race_2017, race_2018, race_2019, race_2020)|> 
  select(-c(x,weighted_number,x95_percent_ci_weighted_number, weighted_numbere, x95_percent_c_id_weighted_number, x95_percent_c_id_percent, sample_sizec, sample_size,   prevalence_number , x95_percent_ci_percent, standard_error)) %>% 
 rename(year_name = year)


race_data
```

```{r}
race_asthma_df =
  left_join(merged_df, race_data, by = c("state", "year_name")) %>% 
  drop_na() %>% 
  select(-prevalence_percent.x) %>% 
  rename(prevalence_percent = prevalence_percent.y) %>% 
  mutate(prevalence_prop = prevalence_percent / 100)
```

```{r}
lm_by_race = lm(prevalence_percent ~ avg_temp_yearly + race_ethnicity, data = race_asthma_df)
summary(lm_by_race)

plot(lm_by_race)

interaction_model = lm(prevalence_percent ~ avg_temp_yearly * race_ethnicity, data = race_asthma_df)
summary(interaction_model)

plot(interaction_model)

fit_logistic = glm(prevalence_prop ~ avg_temp_yearly + race_ethnicity, 
                   data = race_asthma_df, 
                   family = binomial())
summary(fit_logistic)

plot(fit_logistic)
```


```{r}
race_asthma_df =
  race_asthma_df %>% 
  mutate(yhat = predict(lm_by_race, newdata = race_asthma_df)) 

ggplot(race_asthma_df, aes(x = avg_temp_yearly, y = prevalence_percent, color = race_ethnicity)) +
  geom_point() +
  geom_line(aes(y = yhat)) +
  facet_wrap(~ race_ethnicity) +
  labs(
    title = "Asthma Prevalence by Race and Temperature",
    x = "Average Yearly Temperature",
    y = "Asthma Prevalence (%)",
    caption = "line shows predicted prevalence % equation and data points show actual asthma prevalence"
  ) +
  theme(legend.position="none")
```

## MLR of race, income, and yearly temp
```{r}
# We use asthma_dataset here, first need to unnest the data
unnested_df = 
  asthma_dataset |> 
  select(-prevalence_percent) |> 
  unnest(race) |> 
  rename(prevalence_race = prevalence_percent) |> 
  unnest(income) |> 
  rename(prevalence_income = prevalence_percent) |> 
  mutate(joint_prevalence = prevalence_race * prevalence_income / 100) |> # here we assume race and income are independent 
  select(-prevalence_income, -prevalence_race) 

# full dataset contains race, income, yearly_temp, and joint prevalence
full_df = 
  left_join(unnested_df, merged_df, by = c("year_name", "state")) |> 
  select(-prevalence_percent)
```

```{r}
# data cleaning
full_df = 
  full_df |> 
  drop_na(c(joint_prevalence, avg_temp_yearly)) |> 
  filter(joint_prevalence != 0) |> 
  mutate(log_prevalence = log(joint_prevalence)) |> 
  mutate(race = as.factor(race),
         income = as.factor(income))

# distribution of outcome variable
ggplot(full_df, aes(x = log_prevalence)) + 
  geom_histogram() +
labs(
  title = "distribution of log-transformed outcome variable",
  xlab = "Log-prevalence",
  ylab = "Frequency"
)

# distribution after log-transform looks normal
```

```{r}
model = lm(log_prevalence ~ race + income + avg_temp_yearly, data = full_df)
summary(model)
```
R-squared: 0.4398 (~44%), meaning the model explains ~44% of the variance in the log-transformed prevalence.
Adjusted R-squared: 0.4388, similar to the R-squared, indicating that the model generalizes well with the predictors.

Race is a significant predictor overall, but not all race categories are significant. Different racial groups show varying relationships with the outcome. Income is a highly significant predictor, with lower income categories having significantly lower log-prevalence. As the yearly average temperature increases by 1 unit, the log-prevalence decreases slightly (negative association)


```{r}
# Diagnostic plots
par(mfrow = c(2, 2))
plot(model)
```
