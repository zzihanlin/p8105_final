---
title: "Untitled"
author: "Adeena Moghni"
date: "2024-11-25"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(rnoaa)
options(noaakey = Sys.getenv("NOAA_KEY"))
```

```{r}
state_codes = c("AL", "AK", "AZ", "AR", "CA", "CO", "CT", "DE", "FL", "GA", "HI", "ID", "IL", "IN", "IA", "KS", "KY", "LA", "ME", "MD", "MA", "MI", "MN", "MS", "MO", "MT", "NE", "NV", "NH", "NJ", "NM", "NY", "NC", "ND", "OH", "OK", "OR", "PA", "RI", "SC", "SD", "TN", "TX", "UT", "VT", "VA", "WA", "WV", "WI", "WY")

fip_codes = c("01", "02", "04", "05", "06", "08", "09", "10", "12", "13", "15", "16", "17", "18", "19", "20", "21", "22", "23", "24", "25", "26", "27", "28", "29", "30", "31", "32", "33", "34", "35", "36", "37", "38", "39", "40", "41", "42", "44", "45", "46", "47", "48", "49", "50", "51", "53", "54", "55", "56")

year = 2001:2021 

temp_function <- function(fip_codes, year) 
  { 
  tryCatch({ 
    weather_data = 
      ncdc(datasetid = "GHCND", 
           locationid = paste0("FIPS:", fip_codes), 
           startdate = as.Date(paste0(year, "-01-01")), 
           enddate = as.Date(paste0(year, "-12-31")),
           datatypeid = "TAVG", 
           limit = 1000) 
    return(weather_data$data) 
    }, error = function(e) 
      {message(paste("Error fetching data for FIPS:", fip_codes, "Year:", year, "\n", e)) 
      return(NULL) 
      })
}
```

```{r}
state_temps_df = 
  expand_grid(
    fip_codes = fip_codes,
    year = year
  ) %>% 
  mutate(
    avg_temp = map2(fip_codes, year, temp_function)) %>% 
  unnest(avg_temp)
```
