---
title: Exploring the Link Between Asthma Trends and Climate Change
output: 
  html_document:
    toc: true
    toc_depth: 2
    toc_float: true
---

## Welcome!

Our project is focused on exploring the possible adverse health effects that could be associated to global climate change.  Specifically, we focused on asthma prevalence as hotter temperatures can lead to more pollen, air pollution, and other lung irritants. Studying these trends will help understand the health risks in vulnerable populations.


## Temperature Trends

(brief summary of findings and link to maps page here)

## Regression Analysis

(brief summary of findings and link to regression here)

## Report

For more insight on our motivation, methods, and analyses, please read our report (here)[final_report.html]

## Meet Our Team Members!

This project was completed by:

Hanchuan Chen
Tasya Dita 
Zihan Lin
Adeena Moghni
Kimberly Palaguachi-Lopez

## Screencast
```{r setup, include=FALSE}
library(tidyverse)
library(rnoaa)
library(furrr)
library(rvest)
library(httr)
```
## Asthma data
```{r asthma dataset, }
#write the data loading steps
asthma_2011 = read_html("https://www.cdc.gov/asthma/brfss/2011/tableC1.htm") %>% 
  html_table() %>% 
  bind_rows() %>% 
  janitor::clean_names() %>% 
  select(1:4) %>% 
  filter(!state %in% c("U.S. Total**", "Territories", "PR")) %>% 
  mutate(year = "2011")

#i use current asthma prevalence (table c1) rather than lifetime prevalence and only keep the prevalence percent (instead of numbers) 
#i am excluding PR, VI, and GU

#write the functions for data loading

asthma_hmtl = function(url) {
  
  df = 
    read_html(url) %>% 
    html_table() %>% 
    bind_rows() %>% 
    janitor::clean_names() %>% 
    select(1:4) %>% 
    mutate(standard_error = as.numeric(standard_error)) %>% 
    filter(!state %in% c("U.S. Total**", "U.S. Totalf", "Territories", "PR", "GU", "VI")) %>% 
    mutate(prevalence_percent = as.numeric(prevalence_percent))
}

#prevalence
asthma_prevalence = 
  tibble(
    year_name = 2011:2021,
    data_url = c(
    "https://www.cdc.gov/asthma/brfss/2011/tableC1.htm",
    "https://www.cdc.gov/asthma/brfss/2012/tableC1.htm", 
    "https://www.cdc.gov/asthma/brfss/2013/tableC1.htm",
    "https://www.cdc.gov/asthma/brfss/2014/tableC1.htm",
    "https://www.cdc.gov/asthma/brfss/2015/tableC1.htm",
    "https://www.cdc.gov/asthma/brfss/2016/tableC1.htm",
    "https://www.cdc.gov/asthma/brfss/2017/tableC1.htm",
    "https://www.cdc.gov/asthma/brfss/2018/tableC1.html",
    "https://www.cdc.gov/asthma/brfss/2019/tableC1.html",
    "https://www.cdc.gov/asthma/brfss/2020/tableC1.html",
    "https://www.cdc.gov/asthma/brfss/2021/tableC1.html")
  ) %>% 
  mutate(asthma_byyear = map(data_url, asthma_hmtl)) %>% 
  unnest(asthma_byyear) %>% 
  select(-data_url, -sample_size, -sample_sizec, -standard_error) %>% 
  group_by(year_name)

#starting from 2016, has column called "weighted_number" instead of prevalence number
#2016 and 2021 includes VI (removed)
#2020 and 2021 has U.S. totalf (removed)
#2019 and 2021 only has 49 states (-NJ and -FL)

asthma_prevalence %>% 
  mutate(year_name = as.factor(year_name)) %>% 
  ggplot(aes(x = year_name, y = prevalence_percent)) + 
  geom_boxplot(aes(fill = year_name), color = "blue", alpha = .5) + 
  labs(
    x = "Year",
    y = "Prevalence_percent",
    title = "Asthma cases by year"
  ) +
  theme_minimal()

asthma_prevalence %>% 
  ggplot(aes(x = state, y = prevalence_percent)) + 
  geom_boxplot() + 
  labs(
    x = "State",
    y = "Prevalence_percent",
    title = "Asthma cases by state"
  ) +
  theme_minimal()

#function 2 for race and income data
asthma_hmtl2 = function(url) {
  
  df = 
    read_html(url) %>% 
    html_table() %>% 
    bind_rows() %>% 
    janitor::clean_names() %>% 
    select(1:4) %>% 
    filter(!state %in% c("U.S. Total**", "U.S. Totalf", "Territories", "PR", "GU", "VI")) %>% 
    mutate(prevalence_percent = as.numeric(prevalence_percent))
}

#race
asthma_prace = 
  tibble(
    year_name = 2011:2021,
    data_url = c(
    "https://www.cdc.gov/asthma/brfss/2011/tableC4.htm",
    "https://www.cdc.gov/asthma/brfss/2012/tableC4.htm", 
    "https://www.cdc.gov/asthma/brfss/2013/tableC4.htm",
    "https://www.cdc.gov/asthma/brfss/2014/tableC4.htm",
    "https://www.cdc.gov/asthma/brfss/2015/tableC4.htm",
    "https://www.cdc.gov/asthma/brfss/2016/tableC4.htm",
    "https://www.cdc.gov/asthma/brfss/2017/tableC4.htm",
    "https://www.cdc.gov/asthma/brfss/2018/tableC4.html",
    "https://www.cdc.gov/asthma/brfss/2019/tableC4.html",
    "https://www.cdc.gov/asthma/brfss/2020/tableC4.html",
    "https://www.cdc.gov/asthma/brfss/2021/tableC4.html")
  ) %>% 
  mutate(asthma_byyear = map(data_url, asthma_hmtl2)) %>% 
  unnest(asthma_byyear)

#2020, race designation is in column raceg. 2021 in column race_ethnicityg
asthma_prace = asthma_prace %>% 
  select(-data_url, -sample_size, -sample_sizec) %>% 
  mutate(
    race = ifelse(is.na(race), raceg, race), 
    race = ifelse(is.na(race), race_ethnicityg, race)
    ) %>% 
  select(-raceg, -race_ethnicityg) %>%
  nest(race, prevalence_percent)

#income
asthma_pincome = 
  tibble(
    year_name = 2011:2021,
    data_url = c(
    "https://www.cdc.gov/asthma/brfss/2011/tableC7.htm",
    "https://www.cdc.gov/asthma/brfss/2012/tableC7.htm", 
    "https://www.cdc.gov/asthma/brfss/2013/tableC7.htm",
    "https://www.cdc.gov/asthma/brfss/2014/tableC7.htm",
    "https://www.cdc.gov/asthma/brfss/2015/tableC7.htm",
    "https://www.cdc.gov/asthma/brfss/2016/tableC7.htm",
    "https://www.cdc.gov/asthma/brfss/2017/tableC7.htm",
    "https://www.cdc.gov/asthma/brfss/2018/tableC7.html",
    "https://www.cdc.gov/asthma/brfss/2019/tableC7.html",
    "https://www.cdc.gov/asthma/brfss/2020/tableC7.html",
    "https://www.cdc.gov/asthma/brfss/2021/tableC6.html")
  ) %>% 
  mutate(asthma_byyear = map(data_url, asthma_hmtl2)) %>% 
  unnest(asthma_byyear) %>% 
  select(-data_url, -sample_size, -sample_sizec) %>% 
  nest(income, prevalence_percent)

#asthma dataset
asthma_dataset = 
  inner_join(asthma_prevalence, asthma_prace, by = c("year_name", "state")) %>% 
  inner_join(asthma_pincome, by = c("year_name", "state")) %>% 
  janitor::clean_names() %>% 
  rename("race" = "data_x", "income" = "data_y")
```

## fit linear regression
```{r}
# 1. merge asthma prevalance and temp data 
# import two dataset
temp_df = read_csv("data/temp_data.csv")
summary(temp_df)

asthma_df = read_csv("data/asthma_data.csv")
summary(asthma_df)

# find the yearly temperature by state
temp_yearly_df = 
  temp_df |> 
  group_by(state, year) |> 
  summarize(avg_yearly = mean(avg_temp)) |> 
  select(state, year_name = year, avg_temp_yearly = avg_yearly)

# merge two dataset
merged_df = 
  left_join(asthma_df, temp_yearly_df, by=c("state", "year_name")) |> 
  drop_na() 
# after merging yearly avg temperature and prevalence, DC has no temp data
```

```{r}
# 2. do EDA and check distribution assumption
temp_df |> 
  ggplot(aes(x = avg_temp)) +
  geom_histogram() +
  labs(
    title = "distribution of average temperature in 2011-2021",
    xlab = "average temperature",
    ylab = "frequency"
  )

asthma_df |> 
  ggplot(aes(x = prevalence_percent)) +
  geom_histogram() +
  labs(
    title = "distribution of prevalence in 2011-2021",
    xlab = "prevalence (percent)",
    ylab = "frequency"
  )

# two variables generally follows normal distribution
```

```{r}
# bar plot of temperature and line plot of prevalence by each state
merged_df |> 
  mutate(state = reorder(state, avg_temp_yearly)) |> 
  group_by(state) |> 
  summarize(prevalence = mean(prevalence_percent),
            temp = mean(avg_temp_yearly)) |> 
  ggplot(aes(x = state)) +
    geom_bar(aes(y = temp), stat = "identity", fill = "skyblue") +
    geom_line(aes(y = prevalence, group = 1)) +
    geom_point(aes(y = prevalence), color = "red") +
    scale_y_continuous(
      name = "temperature",
      sec.axis = sec_axis(~., name = "Prevalence (%)")
    ) +
  labs(
    title = "Temperature and Prevalence by State",
    color = "legend"
  )

```

```{r}
# 3. do linear regression
model = lm(prevalence_percent ~ avg_temp_yearly, data = merged_df)
summary(model)

par(mfrow = c(2,2))
plot(model)

# try log transform outcome
model_log = 
  merged_df |> 
    mutate(log_precalence = log(prevalence_percent)) |> 
    lm(log_precalence ~ avg_temp_yearly, data = _)
summary(model_log)

par(mfrow = c(2,2))
plot(model_log)
# 4. results explanation and visualization
```




## Race Data & Asthma Prevalance 

Function to download and tidy html table from online 
```{r}
race_table = function(url, year ){
  
  table= 
    read_html(url)|>
    html_table()|>
    first()|>
    slice(-1:-5)
  
  table|>
    janitor::clean_names()|>
    select(-c(x,x95_percent_ci_number))|> 
    mutate(year= year)
  
}

race_table1 = function(url, year){
  
  table= 
    read_html(url)|>
    html_table()|>
    first()|>
    slice(-1:-5)
  
  table|>
    janitor::clean_names()|> 
    mutate( year= year)
  
}

race_table_a8 = function(url, year){
  
  html= read_html(url)
  
  table=
    html|>
    html_table()|>
    first()|>
    slice(-1:-5)
  
  table|>
    janitor::clean_names()|> 
    select(-c(x))|> 
    mutate( 
      year= year)
  
}
```

Run function on all years: 
```{r}
race_2011= race_table("https://www.cdc.gov/asthma/brfss/2011/tableL5.htm", 2011)


race_2012= race_table("https://www.cdc.gov/asthma/brfss/2012/tableL5.htm", 2012)
race_2013= race_table("https://www.cdc.gov/asthma/brfss/2013/tableL5.htm", 2013)
race_2014= race_table("https://www.cdc.gov/asthma/brfss/2014/tableL5.htm", 2014)
race_2015= race_table("https://www.cdc.gov/asthma/brfss/2015/tableL5.htm", 2015)
race_2016= race_table("https://www.cdc.gov/asthma/brfss/2016/tableL5.htm", 2016)
race_2017= race_table1("https://www.cdc.gov/asthma/brfss/2017/tableL5.htm", 2017)
race_2018= race_table_a8("https://www.cdc.gov/asthma/brfss/2018/tableL5.html", 2018)
race_2019= race_table_a8("https://www.cdc.gov/asthma/brfss/2019/tableL5.html", 2019)
race_2020= race_table_a8("https://www.cdc.gov/asthma/brfss/2020/tableL5.html", 2020)|> 
  mutate( race_ethnicity= race_ethnicityg)|> 
  select(-race_ethnicityg)
```

I excluded 2021 since the brackets for race ethnicity were changed and no longer consistent with the previous years where there was a multirace NH category which was no longer used. 

Merged Race data: 
```{r}
race_data= 
  bind_rows(race_2011, race_2012, race_2013, race_2014, race_2015, race_2016, 
                           race_2017, race_2018, race_2019, race_2020)|> 
  select(-c(x,weighted_number,x95_percent_ci_weighted_number, weighted_numbere, x95_percent_c_id_weighted_number, x95_percent_c_id_percent, sample_sizec, sample_size,   prevalence_number , x95_percent_ci_percent, standard_error)) %>% 
 rename(year_name = year)


race_data
```

```{r}
race_asthma_df =
  left_join(merged_df, race_data, by = c("state", "year_name")) %>% 
  drop_na() %>% 
  select(-prevalence_percent.x) %>% 
  rename(prevalence_percent = prevalence_percent.y) %>% 
  mutate(prevalence_prop = prevalence_percent / 100)
```

```{r}
lm_by_race = lm(prevalence_percent ~ avg_temp_yearly + race_ethnicity, data = race_asthma_df)
summary(lm_by_race)

plot(lm_by_race)

interaction_model = lm(prevalence_percent ~ avg_temp_yearly * race_ethnicity, data = race_asthma_df)
summary(interaction_model)

plot(interaction_model)

fit_logistic = glm(prevalence_prop ~ avg_temp_yearly + race_ethnicity, 
                   data = race_asthma_df, 
                   family = binomial())
summary(fit_logistic)

plot(fit_logistic)
```


```{r}
race_asthma_df =
  race_asthma_df %>% 
  mutate(yhat = predict(lm_by_race, newdata = race_asthma_df)) 

ggplot(race_asthma_df, aes(x = avg_temp_yearly, y = prevalence_percent, color = race_ethnicity)) +
  geom_point() +
  geom_line(aes(y = yhat)) +
  facet_wrap(~ race_ethnicity) +
  labs(
    title = "Asthma Prevalence by Race and Temperature",
    x = "Average Yearly Temperature",
    y = "Asthma Prevalence (%)",
    caption = "line shows predicted prevalence % equation and data points show actual asthma prevalence"
  ) +
  theme(legend.position="none")
```

